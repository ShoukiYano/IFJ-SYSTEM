generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  CANCELLED
}

enum TemplateType {
  STANDARD
  SES
}

model Company {
  id                 String  @id @default(uuid())
  name               String
  zipCode            String
  address            String
  tel                String?
  email              String?
  registrationNumber String? // 適格請求書発行事業者番号
  bankName           String?
  bankBranch         String?
  bankAccountType    String? // 普通 / 当座
  bankAccountNumber  String?
  bankAccountName    String?
  logoUrl            String?
  stampUrl           String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Client {
  id             String    @id @default(uuid())
  name           String
  department     String?
  manager        String?
  honorific      String    @default("御中") // 御中 / 様
  zipCode        String?
  address        String?
  tel            String?
  email          String?
  paymentTerms   String?
  closingDay     Int?      @default(31) // 締め日 (1-31, 31は月末)
  paymentMonthOffset Int?  @default(1)  // 支払月 (0:当月, 1:翌月, 2:翌々月)
  paymentDay     Int?      @default(31) // 支払日 (1-31, 31は月末)
  defaultNotes   String?
  isRecurring    Boolean   @default(false)
  deletedAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  invoices       Invoice[]
  quotations     Quotation[]
  assignees      Assignee[]
}

model Assignee {
  id                String    @id @default(uuid())
  name              String
  contractStartDate DateTime?
  contractEndDate   DateTime?
  clientId          String
  client            Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

enum QuotationStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  INVOICED
  EXPIRED
}

model Quotation {
  id              String           @id @default(uuid())
  quotationNumber String           @unique
  issueDate       DateTime
  expiryDate      DateTime?
  subject         String?
  registrationNumber String?       // 適格請求書発行事業者番号
  status          QuotationStatus  @default(DRAFT)
  templateType    TemplateType     @default(STANDARD)
  notes           String?
  taxRate         Float            @default(0.10)
  totalAmount     Decimal          @db.Decimal(12, 2)
  taxAmount       Decimal          @db.Decimal(12, 2)
  clientId        String
  client          Client           @relation(fields: [clientId], references: [id])
  items           QuotationItem[]
  invoiceId       String?          @unique
  invoice         Invoice?         @relation(fields: [invoiceId], references: [id])
  deletedAt       DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model QuotationItem {
  id           String    @id @default(uuid())
  description  String
  serviceMonth String?
  personName   String?
  quantity     Decimal   @db.Decimal(10, 2)
  unit         String    @default("式")
  unitPrice    Decimal   @db.Decimal(12, 2)
  amount       Decimal   @db.Decimal(12, 2)
  minHours     Float?
  maxHours     Float?
  overtimeRate Decimal?  @db.Decimal(12, 2)
  deductionRate Decimal? @db.Decimal(12, 2)
  overtimeAmount Decimal? @db.Decimal(12, 2)
  deductionAmount Decimal? @db.Decimal(12, 2)
  order        Int       @default(0)
  quotationId  String
  quotation    Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
}

model Invoice {
  id            String         @id @default(uuid())
  invoiceNumber String         @unique
  issueDate     DateTime
  dueDate       DateTime?
  subject       String?
  registrationNumber String?   // 適格請求書発行事業者番号
  status        InvoiceStatus  @default(DRAFT)
  templateType  TemplateType   @default(STANDARD)
  notes         String?
  taxRate       Float          @default(0.10)
  totalAmount   Decimal        @db.Decimal(12, 2)
  taxAmount     Decimal        @db.Decimal(12, 2)
  clientId      String
  client        Client         @relation(fields: [clientId], references: [id])
  items         InvoiceItem[]
  quotation     Quotation?
  deletedAt     DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model InvoiceItem {
  id               String   @id @default(uuid())
  invoiceId        String
  invoice          Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description      String
  serviceMonth     String?
  personName       String?
  quantity         Decimal  @db.Decimal(12, 2)
  unit             String?  @default("式")
  unitPrice        Decimal  @db.Decimal(12, 2)
  amount           Decimal  @db.Decimal(12, 2)
  minHours         Float?
  minHours2        Float?
  maxHours         Float?
  maxHours2        Float?
  overtimeRate     Decimal? @db.Decimal(12, 2)
  overtimeRate2    Decimal? @db.Decimal(12, 2)
  deductionRate    Decimal? @db.Decimal(12, 2)
  deductionRate2   Decimal? @db.Decimal(12, 2)
  overtimeAmount   Decimal? @db.Decimal(12, 2)
  overtimeAmount2  Decimal? @db.Decimal(12, 2)
  deductionAmount  Decimal? @db.Decimal(12, 2)
  deductionAmount2 Decimal? @db.Decimal(12, 2)
  order            Int      @default(0)
}

model InvoiceSequence {
  id        String   @id @default("default")
  prefix    String   @default("INV-")
  current   Int      @default(1)
  updatedAt DateTime @updatedAt
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?   // Hashed password for Credentials provider
  accounts      Account[]
  sessions      Session[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?  @db.Text
  access_token       String?  @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?  @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  resource  String
  payload   String?  @db.Text
  createdAt DateTime @default(now())
}
